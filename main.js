(()=>{"use strict";let e=document.querySelector("#content");const t=e=>{for(let t=9;t>=0;t--)for(let r=0;r<10;r++){let s=document.createElement("div");s.classList.add("square"),s.setAttribute("data-coords",[t,r]),e.append(s)}};function r(e,t){document.querySelector(".message-help").textContent=`${e.name} has sunk!`;let r=document.createElement("h3");r.classList.add(".sunken"),r.textContent=`${e.name}`,document.querySelector(`.score.${t}`).append(r)}function s(t){o(document.querySelector("#content"));const r=document.createElement("div");e.append(r),r.classList.add("result");const s=document.createElement("div");s.classList.add("label"),s.classList.add("result"),s.textContent="Game Over",r.append(s);const n=document.createElement("div");n.classList.add("message"),n.textContent="playerOne"===t?"You won!":"You lost.",r.append(n)}const o=e=>{let t=null,r=e;for(;null!==r.lastChild;)t=r,r=r.lastChild;t.removeChild(r),null!==e.lastChild&&o(e)};class n{constructor(e,t){this.size=e,this.hits=0,this.coords=null,this.name=t,this.rotation=null}hit(){this.hits+=1}isSunk(){return this.hits>=this.size}}let a=null,l=null;const c=[[1,0],[-1,0],[0,1],[0,-1]];function d(e){let t=e.target.dataset.coords,o=Number(t.charAt(0)),c=Number(t.charAt(t.length-1)),i=a.attack([o,c],l);if(void 0!==i){if(Array.isArray(i)&&(document.querySelector(".message-help").textContent="It's a miss.",e.target.classList.add("miss")),i instanceof n&&(document.querySelector(".message-help").textContent="It's a hit!",e.target.classList.add("hit"),i.isSunk()&&r(i,"two"),l.board.isSunk()))return document.querySelector(".board.attack").removeEventListener("click",d),void s("playerOne");!function(e,t){let o=m(t.playerMoves),a=t.attack([o[0],o[1]],e);if(Array.isArray(a)&&document.querySelector(`.board.defense .square[data-coords = "${o[0]},${o[1]}"]`).classList.add("miss"),a instanceof n&&(u.push([o[0],o[1]]),document.querySelector(`.board.defense .square[data-coords = "${o[0]},${o[1]}"]`).classList.add("hit"),a.isSunk()&&r(a,"one"),e.board.isSunk()))return document.querySelector(".board.attack").removeEventListener("click",d),void s("playerTwo");document.querySelector(".message-help").textContent="Open fire on enemy ships."}(a,l)}}let i=0,u=[];function m(e){if(0===u.length)return f(e);let t=u[0][0],r=u[0][1],s=h([t,r],e);return null===s?(i=0,u.shift(),m(e)):s}const h=(e,t)=>{if(i>3)return null;let r=Number(e[0])+Number(c[i][0]),s=Number(e[1])+Number(c[i][1]);return r>9||s>9||r<0||s<0||t.filter((e=>e[0]===r&&e[1]===s)).length>0?(i++,h(e,t)):[r,s]},f=e=>{let t=Math.trunc(10*Math.random()),r=Math.trunc(10*Math.random());for(let s=0;s<e.length;s++){if(t===e[s][0]&&r===e[s][1])return f(e);e.filter((e=>e[0]===t+2&&e[1]===r)).length>0&&e.filter((e=>e[0]===t-2&&e[1]===r)).length>0&&e.filter((e=>e[0]===t&&e[1]===r+2)).length>0&&e.filter((e=>e[0]===t&&e[1]===r-2))}return[t,r]};class p{constructor(){this.playedSquares=[],this.carrier=new n(5,"Carrier"),this.battleship=new n(4,"BattleShip"),this.destroyer=new n(3,"Destroyer"),this.submarine=new n(3,"Submarine"),this.patrol=new n(2,"Patrol Boat"),this.fleet=[[this.carrier],[this.battleship],[this.destroyer],[this.submarine],[this.patrol]]}place(e,[t,r],[s,o]){e.coords=[[t,r],[s,o]]}receiveAttack([e,t]){if(-1===y([e,t],this.playedSquares))return"Square already played.";this.playedSquares.push([e,t]);let r=L([e,t],this.fleet);return null!==r?(r.hit(),r):[e,t]}isSunk(){for(let e of this.fleet)if(!e[0].isSunk())return!1;return!0}}const y=([e,t],r)=>{for(let s=0;s<r.length;s++){let o=r[s][0],n=r[s][1];if(o===e&&n===t)return-1}},L=([e,t],r)=>{for(let s=0;s<r.length;s++){let o=r[s][0];if(null===o.coords)continue;let n=o.coords[0],a=o.coords[1],l=n[0],c=n[1],d=a[0],i=a[1];if(l===d&&e===l&&c<=t&&t<=i)return o;if(c===i&&t===c&&l<=e&&e<=d)return o}return null};class b{constructor(){this.board=new p,this.turn=!1,this.playerMoves=[]}attack([e,t],r){if(-1!==S([e,t],this.playerMoves))return r.board.receiveAttack([e,t])}}const S=([e,t],r)=>{for(let s=0;s<r.length;s++)if(e===r[s][0]&&t===r[s][1])return-1;return r.push([e,t]),0};let v=null,q=null;function g(e){E();let t=e.target.dataset.coords,r=Number(t.charAt(0)),s=Number(t.charAt(t.length-1));if(q=C(),v=document.querySelector("button").className,"hor"===v){let e=document.querySelectorAll(`.board.defense .square.ship[data-coords ^= "${r}"`);if(e.length>0){let t=[];for(let r=0;r<e.length;r++){let s=e[r].dataset.coords,o=Number(s.charAt(s.length-1));t.push(o)}let o=-1,n=100;for(let e=0;e<t.length;e++){let r=t[e];r>o&&(o=r),r<n&&(n=r)}if(s-q<n&&n<=s||s-q<o&&o<=s){for(let e=0;e<q;e++)document.querySelector(`.board.defense .square[data-coords = "${r},${s-e}"]`).classList.add("incorrect");return}}if(s+1-q<0){for(let e=0;e<q;e++)s-e<0||document.querySelector(`.board.defense .square[data-coords = "${r},${s-e}"]`).classList.add("incorrect");return}for(let e=0;e<q;e++)document.querySelector(`.board.defense .square[data-coords = "${r},${s-e}"]`).classList.add("correct")}else{let e=document.querySelectorAll(`.board.defense .square.ship[data-coords $= "${s}"`);if(e.length>0){let t=[];for(let r=0;r<e.length;r++){let s=e[r].dataset.coords,o=Number(s.charAt(0));t.push(o)}let o=-1,n=100;for(let e=0;e<t.length;e++){let r=t[e];r>o&&(o=r),r<n&&(n=r)}if(r-q<n&&n<=r||r-q<o&&o<=r){for(let e=0;e<q;e++)document.querySelector(`.board.defense .square[data-coords = "${r-e},${s}"]`).classList.add("incorrect");return}}if(r+1-q<0){for(let e=0;e<q;e++)r-e<0||document.querySelector(`.board.defense .square[data-coords = "${r-e},${s}"]`).classList.add("incorrect");return}for(let e=0;e<q;e++)document.querySelector(`.board.defense .square[data-coords = "${r-e},${s}"]`).classList.add("correct")}}const C=()=>{let e=document.querySelector(".message-help");return e.classList.contains("Carrier")?5:e.classList.contains("BattleShip")?4:e.classList.contains("Destroyer")||e.classList.contains("Submarine")?3:e.classList.contains("Patrol")?2:void 0},E=()=>{for(let e=0;e<10;e++)for(let t=0;t<10;t++){let r=document.querySelector(`.board.defense .square[data-coords = "${e},${t}"]`);r.classList.contains("incorrect")&&r.classList.remove("incorrect"),r.classList.contains("correct")&&r.classList.remove("correct")}};let $=new b,k=new b,A=["Carrier","BattleShip","Destroyer","Submarine","Patrol Boat"],x=null,w=null;!function(){let t=document.createElement("h1");t.textContent="BATTLESHIP",document.querySelector("body").prepend(t);let r=document.createElement("button");r.classList.add("new-game"),e.appendChild(r),r.textContent="START NEW GAME"}(),new Promise((r=>{document.querySelector(".new-game").addEventListener("click",(()=>{(function(){let r=document.querySelectorAll("#content *");for(let t of r)e.removeChild(t);let s=document.createElement("div");s.classList.add("boards-container");let o=document.createElement("div");o.classList.add("board"),o.classList.add("defense");let n=document.createElement("div");n.classList.add("board"),n.classList.add("attack"),e.appendChild(s),s.appendChild(o),s.appendChild(n),t(o),t(n),function(){let t=document.createElement("div");t.classList.add("message-help");let r=document.createElement("div");r.classList.add("rotate-help");let s=document.createElement("div");s.textContent="Press R to rotate your ship.";let o=document.createElement("button");o.textContent="Horizontal placement",o.classList.add("hor"),e.appendChild(t),e.appendChild(r),r.appendChild(s),r.appendChild(o)}()})(),r()}))})).then((()=>{document.addEventListener("keydown",D),O(),P(),w=$,document.querySelector(".board.defense").addEventListener("click",N),document.querySelector(".board.defense").addEventListener("mouseover",g)}));const N=e=>{let t=e.target.dataset.coords,r=document.querySelector("button").className;M(Number(t.charAt(0)),Number(t.charAt(t.length-1)),r)};function M(e,t,r){let s=T(x);if(null===s.coords){const o=B([e,t],s.size,r),c=function([e,t],r,s){for(const[o,a]of Object.entries(w.board))if(a instanceof n&&a.name!==x){if(null===a.coords)continue;let o=a.coords[0],n=a.coords[1],l=o[0],c=o[1],d=n[0],i=n[1],u=a.rotation;if("hor"===u){if("hor"===s&&e===l&&c<=t&&t<=i+r-1)return-1;if("ver"===s&&c<=t&&t<=i&&e>=l&&e<l+r)return-1}if("ver"===u){if("hor"===s&&l<=e&&e<=d&&t>=c&&t-r+1<=c)return-1;if("ver"===s&&t===c&&l<=e&&e<=d+r-1)return-1}}}([e,t],s.size,r);if(-1!==o&&-1!==c){if(s.rotation=r,w.board.place(s,o[0],o[1]),w===$&&(([[e,t],[r,s],o],n)=>{if(document.querySelector(`.board.defense .square[data-coords = "${e},${t}"`).classList.add("ship"),"hor"===o)for(let t=0;t<n;t++)document.querySelector(`.board.defense .square[data-coords = "${e},${s-t}"]`).classList.add("ship");if("ver"===o)for(let e=0;e<n;e++)document.querySelector(`.board.defense .square[data-coords = "${r-e},${t}"]`).classList.add("ship")})(o,s.size),0===A.length&&w===$&&(A=["Carrier","BattleShip","Destroyer","Submarine","Patrol Boat"],document.querySelector(".message-help").textContent="LETS GET READY TO RUMBLE",w=k,document.querySelector("#content").removeChild(document.querySelector(".rotate-help")),document.removeEventListener("keydown",D),document.querySelector(".board.defense").removeEventListener("mouseover",g),document.querySelector(".board.defense").removeEventListener("click",N)),0===A.length&&w===k)return a=$,l=k,function(){let e=document.querySelector(".boards-container"),t=document.createElement("div");e.prepend(t),t.classList.add("score"),t.classList.add("one");let r=document.createElement("div");r.textContent="Friendly ships lost in battle",r.classList.add("label"),t.append(r);let s=document.createElement("div");e.append(s),s.classList.add("score"),s.classList.add("two");let o=document.createElement("div");o.textContent="Defeated enemy ships",o.classList.add("label"),s.append(o)}(),document.querySelector(".message-help").textContent="Open fire on enemy ships.",document.querySelector(".board.attack").addEventListener("click",d),void document.querySelector(".board.attack").classList.add("hoverable");O(),w===$&&P()}w===k&&function(){let e=z();M(e.coords[0],e.coords[1],e.rotation)}()}}const B=([e,t],r,s)=>"hor"===s?t+1<r?-1:[[e,t-r+1],[e,t],"hor"]:"ver"===s?e+1<r?-1:[[e-r+1,t],[e,t],"ver"]:void 0,P=()=>{let e=document.querySelector(".message-help");e.textContent=`Place your ${x}`;let t=e.classList;for(let r of t)"message-help"!==r&&e.classList.remove(`${r}`);if("Patrol Boat"===x)return e.classList.add("Patrol"),void e.classList.add("Boat");e.classList.add(`${x}`)},O=()=>{x=A.shift()},T=e=>{for(const[t,r]of Object.entries(w.board))if(r instanceof n&&r.name===e)return r},z=()=>({coords:[Math.trunc(10*Math.random()),Math.trunc(10*Math.random())],rotation:["hor","ver"][Math.random()>.5?0:1]});function D(e){if("r"===e.key||"R"===e.key){let e=document.querySelector("button");e.classList.contains("hor")?(e.classList.remove("hor"),e.classList.add("ver"),e.textContent="Vertical placement"):e.classList.contains("ver")&&(e.classList.remove("ver"),e.classList.add("hor"),e.textContent="Horizontal placement")}}})();